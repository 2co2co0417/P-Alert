<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>アラート設定 - P-Alert</title>
</head>

<body style="font-family:sans-serif; max-width:720px; margin:24px auto; padding:0 16px;">

  <h1>アラート設定</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
        {{ messages[0] }}
      </div>
    {% endif %}
  {% endwith %}

  <!-- いまの実効しきい値（落ちない保険つき） -->
  <div style="background:#eef6ff; padding:12px; border-radius:10px; margin:12px 0 18px;">
    <b>いまの実効しきい値：</b>
    <span style="font-size:18px;">
      {{ "%.1f"|format(effective|default(0.0)) }} hPa
    </span>

    <div style="font-size:13px; color:#555; margin-top:6px;">
      実効しきい値 = 基本（{{ s.base_threshold }}） − 飲酒（{{ s.drink_offset }}）
      {% if s.pollen_enabled == 1 %}
        − 花粉（{{ s.pollen_offset }}）
      {% else %}
        − 花粉（0.0）
      {% endif %}
    </div>

    <div style="font-size:13px; color:#666; margin-top:6px;">
      ※数値が小さいほど通知が来やすくなります
    </div>
  </div>

  <!-- 保存フォーム -->
  <form method="POST" action="{{ url_for('settei.settei_home') }}" style="display:grid; gap:18px;">

    <div>
      <label><b>基本アラート値（hPa）</b></label><br>
      <input type="number" step="0.1" name="base_threshold"
             value="{{ s.base_threshold }}" style="padding:8px; width:180px;">
      <div style="font-size:13px; color:#666; margin-top:6px;">
        通常は 4.0、テスト時は 1.0 など
      </div>
    </div>

    <div>
      <label><b>飲酒補正</b></label><br>
      {% set d = s.drink_offset %}
      <select name="drink_choice" style="padding:8px; width:260px;">
        <option value="none" {% if d == 0.0 %}selected{% endif %}>飲酒なし（0.0）</option>
        <option value="shochu" {% if d == 0.5 %}selected{% endif %}>焼酎（0.5）</option>
        <option value="beer_whisky" {% if d == 1.0 %}selected{% endif %}>ビール / ウイスキー（1.0）</option>
        <option value="wine" {% if d == 1.5 %}selected{% endif %}>ワイン（1.5）</option>
      </select>
      <div style="font-size:13px; color:#666; margin-top:6px;">
        数値が大きいほど通知が来やすくなります
      </div>
    </div>

    <div>
      <label><b>花粉補正</b></label><br>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" name="pollen_enabled"
               {% if s.pollen_enabled == 1 %}checked{% endif %}>
        花粉注意報を考慮する（0.5）
      </label>
      <div style="font-size:13px; color:#666; margin-top:6px;">
        将来的にAPI連動可能
      </div>
    </div>

    <button type="submit"
      style="padding:10px; background:#2d6cdf; color:white; border:0; border-radius:10px; font-weight:bold;">
      保存する
    </button>

  </form>

  <!-- テストアラート（別フォーム） -->
  <form method="POST" action="{{ url_for('settei.test_alert') }}" style="margin-top:14px;">
    <button type="submit"
      style="padding:10px; width:100%; background:#111; color:white; border:0; border-radius:10px; font-weight:bold;">
      テストアラート（模擬）を送る
    </button>
    <div style="font-size:13px; color:#666; margin-top:6px;">
      ※いまはメール送信せず、画面に結果を表示します
    </div>
  </form>

  <div style="margin-top:24px;">
    <a href="/">← ダッシュボードへ戻る</a>
  </div>

</body>
</html>