<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P-Alert MVP</title>
</head>
<body style="font-family: sans-serif; max-width: 720px; margin: 24px auto; padding: 0 16px;">

  <div style="display:flex; justify-content: space-between; align-items:center;">
    <h1>P-Alert MVP</h1>
    <a href="/logout">ログアウト</a>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin: 12px 0;">
        {% for msg in messages %}
          <div>• {{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
<h2>気圧ダッシュボード</h2>

<div style="background:#fff7e6; padding:14px; border-radius:12px; margin-bottom:8px;">

  <!-- 上段：タイトル＋バッジ -->
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <strong>48時間の気圧リスク</strong>

    <span id="riskBadge"
      style="padding:6px 12px; border-radius:999px; background:#eee;">
      ---
    </span>
  </div>

  <!-- ★ここが追加した説明文 -->
  <div style="font-size:12px; color:#666; margin-top:6px;">
    安定：±0〜3hPa　注意：±4〜7hPa　警戒：±8hPa以上
  </div>

  <!-- 中段：変化量 -->
  <div style="font-size:32px; font-weight:700; margin:12px 0;">
    <span id="deltaText">--</span> hPa
  </div>
　<div id="dangerText" style="font-size:14px; color:#444; margin-bottom:6px;">
  　最も危険な時間：--
　</div>

  <!-- 下段：グラフ -->
  <canvas id="pressureChart" height="120" style="width:100%;"></canvas>

</div>


  

  <canvas id="pressureChart" height="120" style="width:100%;"></canvas>

</div>

  <div style="margin-top:14px;">
  <a href="/health">▶ 体調記録（ずつうログ）はこちら</a>
</div>




<script>
function drawSimpleLineChart(canvas, labels, values) {
  const ctx = canvas.getContext("2d");

  // 表示サイズを安定させる（CSSで伸び縮みしても崩れにくい）
  const w = canvas.clientWidth || 700;
  const h = canvas.height || 120;
  canvas.width = w;
  canvas.height = h;

  // 余白
  const padL = 40;
  const padR = 10;
  const padT = 10;
  const padB = 25;

  // min/max
  let minV = Math.min(...values);
  let maxV = Math.max(...values);
  if (minV === maxV) { // 変化が無いときの保険
    minV -= 1; maxV += 1;
  }

  // 背景クリア
  ctx.clearRect(0, 0, w, h);

  // 軸（最低限）
  ctx.strokeStyle = "#cccccc";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, h - padB);
  ctx.lineTo(w - padR, h - padB);
  ctx.stroke();

  // 目盛（上・下）
  ctx.fillStyle = "#666";
  ctx.font = "12px sans-serif";
  ctx.fillText(`${maxV.toFixed(1)} hPa`, 4, padT + 10);
  ctx.fillText(`${minV.toFixed(1)} hPa`, 4, h - padB);

  // 折れ線
  const n = values.length;
  const x0 = padL;
  const y0 = h - padB;
  const x1 = w - padR;
  const y1 = padT;

  function x(i) {
    return x0 + (x1 - x0) * (i / (n - 1));
  }
  function y(v) {
    return y0 - (y0 - y1) * ((v - minV) / (maxV - minV));
  }

  ctx.strokeStyle = "#2b6cb0"; // 青っぽい線（固定）
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x(0), y(values[0]));
  for (let i = 1; i < n; i++) {
    ctx.lineTo(x(i), y(values[i]));
  }
  ctx.stroke();

  // X軸ラベル：両端だけ
  ctx.fillStyle = "#666";
  const leftLabel = labels[0] ?? "";
  const rightLabel = labels[n - 1] ?? "";
  ctx.fillText(leftLabel, padL, h - 6);
  const tw = ctx.measureText(rightLabel).width;
  ctx.fillText(rightLabel, w - padR - tw, h - 6);
}

async function drawPressureChart() {
  const res = await fetch("/api/pressure");
  const data = await res.json();

  // 変化量表示
  const d = data.delta_hpa;
document.getElementById("deltaText").textContent =
  (d > 0 ? "+" : "") + d;
document.getElementById("dangerText").textContent =
  "最も危険な時間： " + data.danger_time;


  // リスク表示（色）
  const badge = document.getElementById("riskBadge");
  badge.textContent = data.risk;

  if (data.risk === "警戒") badge.style.background = "#ffcccc";
  else if (data.risk === "注意") badge.style.background = "#ffe5b4";
  else badge.style.background = "#d9fdd3";

  // グラフ描画（Chart.js不要）
  const canvas = document.getElementById("pressureChart");
  drawSimpleLineChart(canvas, data.labels, data.values);
}

// 画面表示後に描く
window.addEventListener("load", drawPressureChart);
</script>

</body>
</html>
